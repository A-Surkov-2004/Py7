{% extends 'base.html' %}

{% block title %}Панель статистики{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">Панель статистики</h1>
    
    <!-- Глобальная статистика -->
    <div class="row mb-5">
        <div class="col-md-4">
            <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                    <h5 class="card-title">Всего опросов</h5>
                    <h2 id="total-questions" class="card-text">Загрузка...</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success mb-3">
                <div class="card-body">
                    <h5 class="card-title">Всего голосов</h5>
                    <h2 id="total-votes" class="card-text">Загрузка...</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-info mb-3">
                <div class="card-body">
                    <h5 class="card-title">Опросов за неделю</h5>
                    <h2 id="recent-questions" class="card-text">Загрузка...</h2>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Поиск опроса -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Статистика по конкретному опросу</h5>
        </div>
        <div class="card-body">
            <div class="input-group mb-3">
                <input type="number" id="question-id" class="form-control" placeholder="Введите ID опроса" min="1">
                <button class="btn btn-primary" onclick="loadQuestionStats()">Загрузить статистику</button>
            </div>
            
            <!-- Результаты -->
            <div id="question-stats" class="mt-3" style="display: none;">
                <h4 id="question-title"></h4>
                <div class="row">
                    <div class="col-md-6">
                        <table class="table" id="stats-table">
                            <thead>
                                <tr>
                                    <th>Вариант ответа</th>
                                    <th>Голоса</th>
                                    <th>Процент</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <div id="chart-container">
                            <!-- График будет здесь -->
                        </div>
                    </div>
                </div>
                
                <!-- Кнопки экспорта -->
                <div class="mt-3">
                    <a id="export-csv" class="btn btn-outline-success me-2" href="#">
                        <i class="fas fa-file-csv"></i> Экспорт CSV
                    </a>
                    <a id="export-json" class="btn btn-outline-primary me-2" href="#">
                        <i class="fas fa-file-code"></i> Экспорт JSON
                    </a>
                    <button class="btn btn-outline-info" onclick="loadChart()">
                        <i class="fas fa-chart-pie"></i> Обновить график
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Популярные опросы -->
    <div class="card">
        <div class="card-header">
            <h5>Самые популярные опросы</h5>
        </div>
        <div class="card-body">
            <table class="table" id="popular-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Вопрос</th>
                        <th>Голосов</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- JavaScript для работы с микросервисами -->
<script>
// Загружаем глобальную статистику
fetch('/api/stats/global/')
    .then(response => response.json())
    .then(data => {
        document.getElementById('total-questions').textContent = data.total_questions;
        document.getElementById('total-votes').textContent = data.total_votes;
        document.getElementById('recent-questions').textContent = data.recent_questions;
        
        // Заполняем таблицу популярных опросов
        const tbody = document.querySelector('#popular-table tbody');
        data.popular_questions.forEach(q => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${q.id}</td>
                <td>${q.text}</td>
                <td>${q.votes}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadQuestionStats(${q.id})">
                        Показать
                    </button>
                </td>
            `;
        });
    })
    .catch(error => console.error('Error:', error));

let currentQuestionId = null;

function loadQuestionStats(questionId = null) {
    const inputId = questionId || document.getElementById('question-id').value;
    if (!inputId) {
        alert('Введите ID опроса');
        return;
    }
    
    currentQuestionId = inputId;
    
    // Загружаем статистику
    fetch(`/api/stats/question/${inputId}/`)
        .then(response => {
            if (!response.ok) throw new Error('Ошибка загрузки');
            return response.json();
        })
        .then(data => {
            // Показываем блок статистики
            document.getElementById('question-stats').style.display = 'block';
            document.getElementById('question-title').textContent = data.question_text;
            
            // Заполняем таблицу
            const tbody = document.querySelector('#stats-table tbody');
            tbody.innerHTML = '';
            data.choices.forEach(choice => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${choice.choice_text}</td>
                    <td>${choice.votes_count}</td>
                    <td>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" 
                                 style="width: ${choice.percentage}%">
                                ${choice.percentage}%
                            </div>
                        </div>
                    </td>
                `;
            });
            
            // Обновляем ссылки экспорта
            document.getElementById('export-csv').href = `/api/export/question/${inputId}/csv/`;
            document.getElementById('export-json').href = `/api/export/question/${inputId}/json/`;
            
            // Загружаем график
            loadChart();
        })
        .catch(error => {
            alert('Ошибка: ' + error.message);
        });
}

function loadChart() {
    if (!currentQuestionId) return;
    
    // Используем base64 версию графика
    fetch(`/api/stats/chart/base64/${currentQuestionId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('chart-container').innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <img src="${data.image}" class="img-fluid" alt="График">
                        <p class="mt-2 text-center text-muted">
                            Всего голосов: ${data.total_votes}
                        </p>
                    </div>
                </div>
            `;
        });
}

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', function() {
    // Если в URL есть параметр question_id
    const urlParams = new URLSearchParams(window.location.search);
    const questionId = urlParams.get('question_id');
    if (questionId) {
        document.getElementById('question-id').value = questionId;
        loadQuestionStats(questionId);
    }
});
</script>

<!-- Подключаем FontAwesome для иконок -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
.progress {
    height: 25px;
    margin-top: 5px;
}
.progress-bar {
    line-height: 25px;
    font-size: 12px;
}
.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>
{% endblock %}